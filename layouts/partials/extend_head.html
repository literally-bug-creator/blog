{{- if .Page.Store.Get "hasMermaid" }}
<script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        let mermaidId = 0;

        function getCurrentTheme() {
            return document.documentElement.getAttribute("data-theme") ===
                "dark"
                ? "dark"
                : "light";
        }

        function getMermaidConfig(theme) {
            if (theme === "dark") {
                return {
                    startOnLoad: false,
                    theme: "dark",
                    themeVariables: {
                        darkMode: true,
                        primaryColor: "#bb86fc",
                        primaryTextColor: "#e1e1e1",
                        primaryBorderColor: "#bb86fc",
                        lineColor: "#f1f1f1",
                        sectionBkgColor: "#2a2a2a",
                        altSectionBkgColor: "#1a1a1a",
                        gridColor: "#404040",
                        secondaryColor: "#03dac6",
                        tertiaryColor: "#cf6679",
                        background: "#121212",
                        mainBkg: "#2a2a2a",
                        secondBkg: "#1a1a1a",
                        tertiaryBkg: "#3a3a3a",
                        cScale0: "#2a2a2a",
                        cScale1: "#1e1e1e",
                        cScale2: "#121212",
                        // Class diagram specific
                        classText: "#e1e1e1",
                        // Relationship lines
                        relationColor: "#f1f1f1",
                        // Node backgrounds
                        nodeBkg: "#2a2a2a",
                        nodeBorder: "#bb86fc",
                        clusterBkg: "#1a1a1a",
                        clusterBorder: "#bb86fc",
                        // Text colors
                        titleColor: "#e1e1e1",
                        edgeLabelBackground: "#2a2a2a",
                    },
                };
            } else {
                return {
                    startOnLoad: false,
                    theme: "default",
                    themeVariables: {
                        darkMode: false,
                        primaryColor: "#6366f1",
                        primaryTextColor: "#1f2937",
                        primaryBorderColor: "#4f46e5",
                        lineColor: "#374151",
                        sectionBkgColor: "#f9fafb",
                        altSectionBkgColor: "#f3f4f6",
                        gridColor: "#e5e7eb",
                        secondaryColor: "#10b981",
                        tertiaryColor: "#f59e0b",
                    },
                };
            }
        }

        function initMermaid() {
            const theme = getCurrentTheme();
            const config = getMermaidConfig(theme);
            mermaid.initialize(config);

            // Process all mermaid diagrams
            document.querySelectorAll(".mermaid").forEach(function (element) {
                if (!element.hasAttribute("data-processed")) {
                    const id = "mermaid-" + ++mermaidId;
                    const graphDefinition = element.textContent;
                    element.innerHTML = "";

                    mermaid
                        .render(id, graphDefinition)
                        .then(function (result) {
                            element.innerHTML = result.svg;
                            element.setAttribute("data-processed", "true");
                        })
                        .catch(function (error) {
                            console.error("Mermaid rendering failed:", error);
                            element.innerHTML =
                                '<pre class="mermaid-error">Error rendering diagram</pre>';
                        });
                }
            });
        }

        function reInitMermaid() {
            // Clear all processed diagrams
            document.querySelectorAll(".mermaid").forEach(function (element) {
                element.removeAttribute("data-processed");
                // Store original content if not already stored
                if (!element.hasAttribute("data-original")) {
                    element.setAttribute("data-original", element.textContent);
                } else {
                    // Restore original content
                    element.textContent = element.getAttribute("data-original");
                }
            });

            // Re-initialize with new theme
            initMermaid();
        }

        // Initial load
        initMermaid();

        // Watch for theme changes
        const observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
                if (
                    mutation.type === "attributes" &&
                    mutation.attributeName === "data-theme"
                ) {
                    setTimeout(reInitMermaid, 100); // Small delay to ensure theme has changed
                }
            });
        });

        observer.observe(document.documentElement, {
            attributes: true,
            attributeFilter: ["data-theme"],
        });

        // Aggressive style injection for dark theme
        function injectDarkStyles() {
            const theme = getCurrentTheme();
            let existingStyle = document.getElementById(
                "mermaid-dark-override",
            );

            if (theme === "dark") {
                if (!existingStyle) {
                    const style = document.createElement("style");
                    style.id = "mermaid-dark-override";
                    style.textContent = `
                        .mermaid g.classGroup rect,
                        .mermaid g.cluster rect,
                        .mermaid .class rect {
                            fill: #2a2a2a !important;
                            stroke: #bb86fc !important;
                            stroke-width: 2px !important;
                        }

                        .mermaid g.classGroup text,
                        .mermaid g.cluster text,
                        .mermaid .class text,
                        .mermaid .classTitle,
                        .mermaid .classBox text {
                            fill: #e1e1e1 !important;
                            color: #e1e1e1 !important;
                        }

                        .mermaid .edgeLabel rect {
                            fill: #2a2a2a !important;
                            stroke: #bb86fc !important;
                        }

                        .mermaid .edgeLabel text {
                            fill: #e1e1e1 !important;
                        }
                    `;
                    document.head.appendChild(style);
                }
            } else {
                if (existingStyle) {
                    existingStyle.remove();
                }
            }
        }

        // Apply dark styles after each render
        const originalRender = mermaid.render;
        mermaid.render = function (...args) {
            return originalRender.apply(this, args).then((result) => {
                setTimeout(injectDarkStyles, 50);
                return result;
            });
        };

        // Initial style injection
        injectDarkStyles();
    });
</script>

<style>
    .mermaid {
        text-align: center;
        margin: 20px 0;
        overflow-x: auto;
        background: transparent;
    }

    .mermaid svg {
        max-width: 100%;
        height: auto;
        background: transparent;
    }

    /* Ensure text is visible in both themes */
    [data-theme="light"] .mermaid svg {
        color: #1f2937;
    }

    [data-theme="dark"] .mermaid svg {
        color: #e1e1e1;
    }

    /* Error styling */
    .mermaid-error {
        color: #ef4444;
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 4px;
        padding: 10px;
        margin: 10px 0;
        font-family: monospace;
    }

    [data-theme="dark"] .mermaid-error {
        color: #fca5a5;
        background: #450a0a;
        border-color: #991b1b;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .mermaid {
            margin: 15px 0;
            font-size: 14px;
        }
    }

    /* Force arrow and line visibility in dark theme */
    [data-theme="dark"] .mermaid .edgePath path,
    [data-theme="dark"] .mermaid .edgePath marker-end,
    [data-theme="dark"] .mermaid .edgePath marker-start {
        stroke: #f1f1f1 !important;
        fill: #f1f1f1 !important;
    }

    [data-theme="dark"] .mermaid .arrowheadPath {
        fill: #f1f1f1 !important;
        stroke: #f1f1f1 !important;
    }

    /* Class diagram dark theme overrides */
    [data-theme="dark"] .mermaid .classGroup rect,
    [data-theme="dark"] .mermaid .class rect,
    [data-theme="dark"] .mermaid .cluster rect {
        fill: #2a2a2a !important;
        stroke: #bb86fc !important;
        stroke-width: 2px !important;
    }

    [data-theme="dark"] .mermaid .classGroup text,
    [data-theme="dark"] .mermaid .class text,
    [data-theme="dark"] .mermaid .cluster text,
    [data-theme="dark"] .mermaid .classGroup .title,
    [data-theme="dark"] .mermaid .class .title {
        fill: #e1e1e1 !important;
        color: #e1e1e1 !important;
    }

    [data-theme="dark"] .mermaid .relation,
    [data-theme="dark"] .mermaid .relationshipLine {
        stroke: #f1f1f1 !important;
        stroke-width: 2px !important;
    }

    /* Additional class diagram elements */
    [data-theme="dark"] .mermaid .classGroup .divider,
    [data-theme="dark"] .mermaid .class .divider {
        stroke: #bb86fc !important;
    }

    /* Class box backgrounds and borders */
    [data-theme="dark"] .mermaid g.classGroup rect,
    [data-theme="dark"] .mermaid g.cluster rect {
        fill: #2a2a2a !important;
        stroke: #bb86fc !important;
        stroke-width: 2px !important;
    }

    /* Text elements in classes */
    [data-theme="dark"] .mermaid .classGroup .classTitle,
    [data-theme="dark"] .mermaid .classGroup .classBox text,
    [data-theme="dark"] .mermaid g.classGroup text {
        fill: #e1e1e1 !important;
        color: #e1e1e1 !important;
    }

    /* Method and attribute text */
    [data-theme="dark"] .mermaid .classGroup .classBox .method,
    [data-theme="dark"] .mermaid .classGroup .classBox .attribute {
        fill: #e1e1e1 !important;
    }

    /* Relationship labels */
    [data-theme="dark"] .mermaid .relationshipLabel text {
        fill: #e1e1e1 !important;
        background: #2a2a2a !important;
    }

    /* Edge labels background */
    [data-theme="dark"] .mermaid .edgeLabel rect {
        fill: #2a2a2a !important;
        stroke: #bb86fc !important;
    }

    [data-theme="dark"] .mermaid .edgeLabel text {
        fill: #e1e1e1 !important;
    }
</style>
{{- end }}
