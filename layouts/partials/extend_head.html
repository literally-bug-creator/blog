{{- if .Page.Store.Get "hasMermaid" }}
<script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        let mermaidId = 0;

        function getCurrentTheme() {
            return document.documentElement.getAttribute("data-theme") ===
                "dark"
                ? "dark"
                : "light";
        }

        function getMermaidConfig(theme) {
            if (theme === "dark") {
                return {
                    startOnLoad: false,
                    theme: "dark",
                    themeVariables: {
                        darkMode: true,
                        primaryColor: "#bb86fc",
                        primaryTextColor: "#e1e1e1",
                        primaryBorderColor: "#7c4dff",
                        lineColor: "#f1f1f1",
                        sectionBkgColor: "#1a1a1a",
                        altSectionBkgColor: "#2a2a2a",
                        gridColor: "#404040",
                        secondaryColor: "#03dac6",
                        tertiaryColor: "#cf6679",
                        background: "#121212",
                        mainBkg: "#1e1e1e",
                        secondBkg: "#2a2a2a",
                        tertiaryBkg: "#3a3a3a",
                        cScale0: "#121212",
                        cScale1: "#1e1e1e",
                        cScale2: "#2a2a2a",
                    },
                };
            } else {
                return {
                    startOnLoad: false,
                    theme: "default",
                    themeVariables: {
                        darkMode: false,
                        primaryColor: "#6366f1",
                        primaryTextColor: "#1f2937",
                        primaryBorderColor: "#4f46e5",
                        lineColor: "#374151",
                        sectionBkgColor: "#f9fafb",
                        altSectionBkgColor: "#f3f4f6",
                        gridColor: "#e5e7eb",
                        secondaryColor: "#10b981",
                        tertiaryColor: "#f59e0b",
                    },
                };
            }
        }

        function initMermaid() {
            const theme = getCurrentTheme();
            const config = getMermaidConfig(theme);
            mermaid.initialize(config);

            // Process all mermaid diagrams
            document.querySelectorAll(".mermaid").forEach(function (element) {
                if (!element.hasAttribute("data-processed")) {
                    const id = "mermaid-" + ++mermaidId;
                    const graphDefinition = element.textContent;
                    element.innerHTML = "";

                    mermaid
                        .render(id, graphDefinition)
                        .then(function (result) {
                            element.innerHTML = result.svg;
                            element.setAttribute("data-processed", "true");
                        })
                        .catch(function (error) {
                            console.error("Mermaid rendering failed:", error);
                            element.innerHTML =
                                '<pre class="mermaid-error">Error rendering diagram</pre>';
                        });
                }
            });
        }

        function reInitMermaid() {
            // Clear all processed diagrams
            document.querySelectorAll(".mermaid").forEach(function (element) {
                element.removeAttribute("data-processed");
                // Store original content if not already stored
                if (!element.hasAttribute("data-original")) {
                    element.setAttribute("data-original", element.textContent);
                } else {
                    // Restore original content
                    element.textContent = element.getAttribute("data-original");
                }
            });

            // Re-initialize with new theme
            initMermaid();
        }

        // Initial load
        initMermaid();

        // Watch for theme changes
        const observer = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
                if (
                    mutation.type === "attributes" &&
                    mutation.attributeName === "data-theme"
                ) {
                    setTimeout(reInitMermaid, 100); // Small delay to ensure theme has changed
                }
            });
        });

        observer.observe(document.documentElement, {
            attributes: true,
            attributeFilter: ["data-theme"],
        });
    });
</script>

<style>
    .mermaid {
        text-align: center;
        margin: 20px 0;
        overflow-x: auto;
        background: transparent;
    }

    .mermaid svg {
        max-width: 100%;
        height: auto;
        background: transparent;
    }

    /* Ensure text is visible in both themes */
    [data-theme="light"] .mermaid svg {
        color: #1f2937;
    }

    [data-theme="dark"] .mermaid svg {
        color: #e1e1e1;
    }

    /* Error styling */
    .mermaid-error {
        color: #ef4444;
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 4px;
        padding: 10px;
        margin: 10px 0;
        font-family: monospace;
    }

    [data-theme="dark"] .mermaid-error {
        color: #fca5a5;
        background: #450a0a;
        border-color: #991b1b;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .mermaid {
            margin: 15px 0;
            font-size: 14px;
        }
    }

    /* Force arrow and line visibility in dark theme */
    [data-theme="dark"] .mermaid .edgePath path,
    [data-theme="dark"] .mermaid .edgePath marker-end,
    [data-theme="dark"] .mermaid .edgePath marker-start {
        stroke: #f1f1f1 !important;
        fill: #f1f1f1 !important;
    }

    [data-theme="dark"] .mermaid .arrowheadPath {
        fill: #f1f1f1 !important;
        stroke: #f1f1f1 !important;
    }

    /* Ensure class diagram elements are visible */
    [data-theme="dark"] .mermaid .classGroup rect {
        fill: #2a2a2a !important;
        stroke: #7c4dff !important;
    }

    [data-theme="dark"] .mermaid .classGroup text {
        fill: #e1e1e1 !important;
    }

    [data-theme="dark"] .mermaid .relation {
        stroke: #f1f1f1 !important;
    }
</style>
{{- end }}
