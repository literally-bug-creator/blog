{{- if .Page.Store.Get "hasMermaid" }}
<script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        let mermaidId = 0;

        function renderDiagram(element) {
            if (element.hasAttribute("data-processed")) return;

            const id = "mermaid-" + ++mermaidId;
            const code = element.textContent;

            mermaid
                .render(id, code)
                .then((result) => {
                    element.innerHTML = result.svg;
                    element.setAttribute("data-processed", "true");
                })
                .catch((error) => {
                    console.error("Mermaid error:", error);
                    element.innerHTML =
                        '<div class="mermaid-error">Diagram error</div>';
                });
        }

        // Initialize with light theme for dark site
        mermaid.initialize({
            startOnLoad: false,
            theme: "default",
            themeVariables: {
                primaryColor: "#f8f9fa",
                primaryTextColor: "#212529",
                primaryBorderColor: "#6c757d",
                lineColor: "#ffffff",
                secondaryColor: "#0d6efd",
                tertiaryColor: "#fd7e14",
                background: "#ffffff",
                mainBkg: "#f8f9fa",
                secondBkg: "#e9ecef",
                tertiaryBkg: "#dee2e6",
                classText: "#212529",
                nodeBkg: "#f8f9fa",
                nodeBorder: "#6c757d",
                clusterBkg: "#e9ecef",
                clusterBorder: "#6c757d",
                relationColor: "#ffffff",
                edgeLabelBackground: "#f8f9fa",
            },
        });

        // Render all diagrams
        document.querySelectorAll(".mermaid").forEach(renderDiagram);
    });
</script>

<style>
    .mermaid {
        text-align: center;
        margin: 20px 0;
        overflow-x: auto;
    }

    .mermaid svg {
        max-width: 100%;
        height: auto;
    }

    .mermaid-error {
        color: #fca5a5;
        background: #450a0a;
        border: 1px solid #991b1b;
        border-radius: 4px;
        padding: 10px;
        font-family: monospace;
    }

    /* Optimal colors for dark background */
    .mermaid rect {
        fill: #f8f9fa !important;
        stroke: #6c757d !important;
        stroke-width: 1.5px !important;
    }

    .mermaid text {
        fill: #212529 !important;
        font-weight: 500 !important;
    }

    .mermaid .edgePath path,
    .mermaid .flowchart-link,
    .mermaid .relation {
        stroke: #ffffff !important;
        stroke-width: 1.5px !important;
    }

    .mermaid .arrowheadPath,
    .mermaid marker path {
        fill: #ffffff !important;
        stroke: #ffffff !important;
    }

    .mermaid .edgeLabel rect {
        fill: #f8f9fa !important;
        stroke: #6c757d !important;
    }

    .mermaid .cluster rect {
        fill: #e9ecef !important;
        stroke: #6c757d !important;
        stroke-width: 1.5px !important;
    }
</style>
{{- end }}
